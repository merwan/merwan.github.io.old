<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Deploiement | Merwan's blog]]></title>
  <link href="http://merwan.github.io/blog/categories/deploiement/atom.xml" rel="self"/>
  <link href="http://merwan.github.io/"/>
  <updated>2015-02-24T23:47:29+01:00</updated>
  <id>http://merwan.github.io/</id>
  <author>
    <name><![CDATA[Merouane Atig]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Déployer Piwik Avec Django]]></title>
    <link href="http://merwan.github.io/blog/2015/02/24/deployer-piwik-avec-django/"/>
    <updated>2015-02-24T22:25:39+01:00</updated>
    <id>http://merwan.github.io/blog/2015/02/24/deployer-piwik-avec-django</id>
    <content type="html"><![CDATA[<p>Aujourd'hui, j'ai voulu intégrer <a href="http://piwik.org/">Piwik Web Analytics</a> dans
une application Django sans ajouter de nouvelle dépendance. La solution la plus
que j'ai trouvé s'appuie sur le fichier de settings et la création d'un
<a href="https://docs.djangoproject.com/en/dev/ref/templates/api/#writing-your-own-context-processors">context processor</a>.</p>

<h2>Définition des variables Piwik dans <code>settings.py</code></h2>

<p>Dans le fichier <code>settings.py</code>, ajouter des variables pour l'URL de votre instance
Piwik et l'ID du site.
<code>python
PIWIK_IDSITE = '123'
PIWIK_URL = 'analytics.example.com'
</code></p>

<h2>Création du context processor</h2>

<p>Créer un fichier <code>context_processor.py</code> qui lit les variables de Piwik dans le
fichier de settings et les rends accessibles aux templates.
``` python
from django.conf import settings</p>

<p>def piwik_analytics(request):</p>

<pre><code>return {
    'PIWIK_URL': settings.PIWIK_URL,
    'PIWIK_IDSITE': settings.PIWIK_IDSITE,
}
</code></pre>

<p>```</p>

<h2>Ajout du context processor au settings</h2>

<p>Dans le fichier <code>settings.py</code>, ajouter le context processor à <code>TEMPLATE_CONTEXT_PROCESSORS</code>.
Le plus simple pour conserver les context processors par défaut de Django est de les importer
depuis <code>global_settings</code>.
``` python
from django.conf import global_settings</p>

<p>TEMPLATE_CONTEXT_PROCESSORS = global_settings.TEMPLATE_CONTEXT_PROCESSORS + (</p>

<pre><code>'website.context_processors.piwik_analytics',
</code></pre>

<p>)
```</p>

<h2>Créer un template pour Piwik</h2>

<p>Je préfère créer un fichier de template spécifique <code>piwik.html</code> qui contient le <a href="http://developer.piwik.org/guides/tracking-javascript-guide">JavaScript
de tracking</a> du site. Ce template
peut référencer les variables <code>PIWIK_URL</code> et <code>PIWIK_IDSITE</code> définies dans le context processor.

```
{% if PIWIK_IDSITE %}</p>

<script type="text/javascript">
    var _paq = _paq || [];
    (function(){ var u=(("https:" == document.location.protocol) ? "https://{{ PIWIK_URL }}/" : "http://{{ PIWIK_URL }}/");
    _paq.push(['setSiteId', {{ PIWIK_IDSITE }}]);
    _paq.push(['setTrackerUrl', u+'piwik.php']);
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0]; g.type='text/javascript'; g.defer=true; g.async=true; g.src=u+'piwik.js';
    s.parentNode.insertBefore(g,s); })();
</script>


<p>{% endif %}
<code>``

Ce script est inclus uniquement quand on a renseigné le</code>PIWIK_IDSITE`. Ceci permet de choisir de
ne pas envoyer de statistiques lorsqu'on est en développement par exemple.</p>

<h2>Intégrer le template Piwik dans le site</h2>

<p>La <a href="http://developer.piwik.org/guides/tracking-javascript-guide">documentation de Piwik</a> conseille
d'ajouter le tracking code juste après le tag <code>&lt;body&gt;</code>. Dans votre fichier <code>base.html</code> ou
équivalent, il faut donc inclure le template piwik que l'on vient de créer.
<code>
(...)
&lt;/head&gt;
&lt;body&gt;
Include file ''piwik.html'' contains invalid characters or sequences
(...)
</code></p>
]]></content>
  </entry>
  
</feed>
